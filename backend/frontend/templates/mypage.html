{% extends "base.html" %}

{% block title %}ë§ˆì´í˜ì´ì§€ | ìì·¨ìƒì˜ ì°½ì˜ ìš”ë¦¬{% endblock %}

{% block content %}
<style>
  .mypage-tab-content { display: none; }
  .mypage-tab-content.active { display: block; }
</style>
<section class="mypage-page">

  <!-- ìƒë‹¨ í”„ë¡œí•„ ì¹´ë“œ -->
  <div class="mypage-profile-card">
    <div class="mypage-profile-main">
      <div class="mypage-avatar">
        <span class="mypage-avatar-icon">ğŸ‘¤</span>
      </div>
      <div class="mypage-user-text">
        <h1 class="mypage-username" id="mypageName">ìš”ë¦¬ì™•ê¹€ë°¥</h1>
        <p class="mypage-user-id" id="mypageLoginId">@cookingking</p>
      </div>
      <button class="mypage-settings-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="mypage-profile-stats">
      <div class="mypage-stat">
        <div class="mypage-stat-icon">ğŸ“–</div>
        <div class="mypage-stat-number" id="mypageRecipeCount"></div>
        <div class="mypage-stat-label">ì‘ì„±í•œ ë ˆì‹œí”¼</div>
      </div>
      <div class="mypage-stat">
        <div class="mypage-stat-icon">â¤ï¸</div>
        <div class="mypage-stat-number" id="mypageLikeCount"></div>
        <div class="mypage-stat-label">ë°›ì€ ì¢‹ì•„ìš”</div>
      </div>
    </div>
  </div>

  <!-- íƒ­ ë©”ë‰´ -->
<div class="mypage-tabs">
  <div class="mypage-tabs-left">
    <button class="mypage-tab active" data-tab="my">ë‚´ ë ˆì‹œí”¼</button>
    <button class="mypage-tab" data-tab="liked">ì¢‹ì•„í•œ ë ˆì‹œí”¼</button>
    <button class="mypage-tab" data-tab="follow">íŒ”ë¡œì‰</button>
  </div>

  <button class="mypage-new-btn">ìƒˆ ë ˆì‹œí”¼ ì‘ì„±</button>
</div>

<!-- ë‚´ ë ˆì‹œí”¼ -->
<div class="mypage-tab-content active" data-content="my">
  <div class="recipe-list mypage-recipe-list" id="myRecipeList"></div>
</div>

<!-- ì¢‹ì•„í•œ ë ˆì‹œí”¼ -->
<div class="mypage-tab-content" data-content="liked">
  <div class="recipe-list mypage-recipe-list" id="likedRecipeList"></div>
</div>

<!-- íŒ”ë¡œì‰ -->
<div class="mypage-tab-content" data-content="follow">
  <div class="mypage-follow-list" id="followList"></div>
</div>

  <script>
document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("accessToken");
  if (!token) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.");
    localStorage.setItem("nextUrl", window.location.pathname);
    window.location.href = "/login/";
    return;
  }

  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("accessToken");
      localStorage.removeItem("nextUrl");
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      window.location.href = "/";
    });
  }

  const newRecipeBtn = document.querySelector(".mypage-new-btn");
  if (newRecipeBtn) {
    newRecipeBtn.addEventListener("click", () => {
      window.location.href = "/recipes/new/";
    });
  }

  // í˜„ì¬ ë¡œê·¸ì¸í•œ member_id ì €ì¥ìš©
  let currentMemberId = null;

  // ---------- 1) ë‚´ ë ˆì‹œí”¼ ë¡œë“œ ----------
  async function loadMyRecipes() {
    const listEl = document.getElementById("myRecipeList");
    if (!listEl) return;
    listEl.innerHTML = "";

    try {
      const res = await fetch("/api/recipes/mine/", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json().catch(() => []);
      if (!res.ok) {
        console.error("ë‚´ ë ˆì‹œí”¼ ëª©ë¡ ì‹¤íŒ¨", res.status, data);
        listEl.innerHTML = "<p class='empty-text'>ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        return;
      }

      const items = Array.isArray(data) ? data : data.results || [];
      if (!items.length) {
        listEl.innerHTML = "<p class='empty-text'>ì•„ì§ ì‘ì„±í•œ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      items.forEach((recipe) => {
        const card = document.createElement("article");
        card.className = "recipe-card";
        card.innerHTML = `
          <a href="/recipes/${recipe.recipe_id}/" class="recipe-link">
            <div class="recipe-thumb">
              ${
                recipe.image_path
                  ? `<img src="${recipe.image_path}" alt="${recipe.title}" class="recipe-thumb-img">`
                  : `<div class="placeholder-thumb"></div>`
              }
            </div>
            <div class="recipe-info">
              <h3 class="recipe-title">${recipe.title}</h3>
              <p class="recipe-desc">${recipe.description ?? ""}</p>
              <div class="recipe-meta">
                <span>${recipe.cooking_time ? `â± ${recipe.cooking_time}ë¶„` : ""}</span>
              </div>
            </div>
          </a>
        `;
        listEl.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      listEl.innerHTML = "<p class='empty-text'>ì„œë²„ ì˜¤ë¥˜ë¡œ ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
    }
  }

  // ---------- 2) ì¢‹ì•„í•œ ë ˆì‹œí”¼ ë¡œë“œ ----------
  async function loadLikedRecipes() {
    const listEl = document.getElementById("likedRecipeList");
    if (!listEl) return;
    listEl.innerHTML = "";

    try {
      const res = await fetch("/api/recipes/liked/", {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json().catch(() => []);
      if (!res.ok) {
        console.error("ì¢‹ì•„ìš” ë ˆì‹œí”¼ ëª©ë¡ ì‹¤íŒ¨", res.status, data);
        listEl.innerHTML = "<p class='empty-text'>ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        return;
      }

      const items = Array.isArray(data) ? data : data.results || [];
      if (!items.length) {
        listEl.innerHTML = "<p class='empty-text'>ì¢‹ì•„í•œ ë ˆì‹œí”¼ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      items.forEach((recipe) => {
        const card = document.createElement("article");
        card.className = "recipe-card";
        card.innerHTML = `
          <a href="/recipes/${recipe.recipe_id}/" class="recipe-link">
            <div class="recipe-thumb">
              ${
                recipe.image_path
                  ? `<img src="${recipe.image_path}" alt="${recipe.title}" class="recipe-thumb-img">`
                  : `<div class="placeholder-thumb"></div>`
              }
            </div>
            <div class="recipe-info">
              <h3 class="recipe-title">${recipe.title}</h3>
              <p class="recipe-desc">${recipe.description ?? ""}</p>
              <div class="recipe-meta">
                <span>${recipe.cooking_time ? `â± ${recipe.cooking_time}ë¶„` : ""}</span>
              </div>
            </div>
          </a>
        `;
        listEl.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      listEl.innerHTML = "<p class='empty-text'>ì„œë²„ ì˜¤ë¥˜ë¡œ ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
    }
  }

  // ---------- 3) íŒ”ë¡œì‰ ëª©ë¡ ë¡œë“œ ----------
  async function loadFollowing() {
    const listEl = document.getElementById("followList");
    if (!listEl || !currentMemberId) return;
    listEl.innerHTML = "";

    try {
      const res = await fetch(`/api/members/${currentMemberId}/following/`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json().catch(() => []);
      if (!res.ok) {
        console.error("íŒ”ë¡œì‰ ëª©ë¡ ì‹¤íŒ¨", res.status, data);
        listEl.innerHTML = "<p class='empty-text'>íŒ”ë¡œì‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        return;
      }

      const items = Array.isArray(data) ? data : data.results || [];
      if (!items.length) {
        listEl.innerHTML = "<p class='empty-text'>ì•„ì§ íŒ”ë¡œì‰í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      items.forEach((member) => {
        const row = document.createElement("div");
        row.className = "follow-item";
        row.innerHTML = `
          <div class="follow-avatar">ğŸ‘¤</div>
          <div class="follow-text">
            <div class="follow-name">${member.name ?? ""}</div>
            <div class="follow-id">@${member.login_id ?? ""}</div>
          </div>
        `;
        listEl.appendChild(row);
      });
    } catch (err) {
      console.error(err);
      listEl.innerHTML = "<p class='empty-text'>ì„œë²„ ì˜¤ë¥˜ë¡œ íŒ”ë¡œì‰ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
    }
  }

  // ---------- íƒ­ í´ë¦­ ì²˜ë¦¬ ----------
  const tabs = document.querySelectorAll(".mypage-tab");
  const tabContents = document.querySelectorAll(".mypage-tab-content");

  function activateTab(tabName) {
    tabs.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tabName);
    });
    tabContents.forEach(box => {
      box.classList.toggle("active", box.dataset.content === tabName);
    });

    // íƒ­ë§ˆë‹¤ í•„ìš”í•œ ë¡œë”© í•¨ìˆ˜ í˜¸ì¶œ
    if (tabName === "my") loadMyRecipes();
    if (tabName === "liked") loadLikedRecipes();
    if (tabName === "follow") loadFollowing();
  }

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      const tabName = btn.dataset.tab;
      activateTab(tabName);
    });
  });

  // ---------- ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° + ì´ˆê¸° íƒ­ ë¡œë“œ ----------
  try {
    const res = await fetch("/api/auth/me/", {
      method: "GET",
      headers: { Authorization: `Bearer ${token}` },
    });

    if (!res.ok) {
      localStorage.removeItem("accessToken");
      alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
      window.location.href = "/login/";
      return;
    }

    const data = await res.json();
    currentMemberId = data.member_id;   // íŒ”ë¡œì‰ API í˜¸ì¶œìš©

    const nameEl = document.getElementById("mypageName");
    const loginIdEl = document.getElementById("mypageLoginId");
    const joinedEl = document.getElementById("mypageJoined");

    if (nameEl) nameEl.textContent = data.name || "(ì´ë¦„ ì—†ìŒ)";
    if (loginIdEl) {
      const loginId = data.login_id || "";
      loginIdEl.textContent = loginId ? `@${loginId}` : "";
    }

    const recipeCountEl = document.getElementById("mypageRecipeCount");
const likeCountEl = document.getElementById("mypageLikeCount");

if (recipeCountEl) {
  recipeCountEl.textContent = data.recipe_count ?? 0;
}
if (likeCountEl) {
  likeCountEl.textContent = data.like_received_count ?? 0;
}

    // ê¸°ë³¸ íƒ­ì€ "ë‚´ ë ˆì‹œí”¼"
    activateTab("my");

  } catch (err) {
    console.error(err);
    alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});
</script>


</section>
{% endblock %}
