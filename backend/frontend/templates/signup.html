{% extends "base.html" %}

{% block title %}íšŒì›ê°€ì… | ìì·¨ìƒì˜ ì°½ì˜ ìš”ë¦¬{% endblock %}

{% block content %}
<section class="auth-page">
  <div class="auth-card">
    <div class="auth-logo-circle">
      <span class="auth-logo-icon">ğŸ³</span>
    </div>

    <h2 class="auth-title">íšŒì›ê°€ì…</h2>
    <p class="auth-subtitle">
      ìì·¨ìƒ ìš”ë¦¬ ì»¤ë®¤ë‹ˆí‹°ì— ê°€ì…í•˜ì„¸ìš”
    </p>

    <form id="signupForm" class="auth-form">
      <label class="auth-label">
        ì´ë¦„
        <input
          type="text"
          id="nameInput"
          class="auth-input"
          placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
          required
        >
      </label>

      <label class="auth-label">
        ì•„ì´ë””
        <input
          type="text"
          id="loginIdInput"
          class="auth-input"
          placeholder="ì‚¬ìš©í•  ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          required
        >
      </label>

      <label class="auth-label">
        ë¹„ë°€ë²ˆí˜¸
        <input
          type="password"
          id="passwordInput"
          class="auth-input"
          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          required
        >
      </label>

      <label class="auth-label">
        ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        <input
          type="password"
          id="passwordConfirmInput"
          class="auth-input"
          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
          required
        >
      </label>

      <label class="auth-remember">
        <input type="checkbox" id="agreeInput">
        <span>ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤</span>
      </label>

      <button type="submit" class="btn auth-submit">
        ê°€ì…í•˜ê¸°
      </button>

      <p id="signupError" class="error auth-error"></p>
    </form>

    <p class="auth-footer-text">
      ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?
      <a href="/login/" class="auth-link">ë¡œê·¸ì¸</a>
    </p>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("signupForm");
  const nameInput = document.getElementById("nameInput");
  const loginIdInput = document.getElementById("loginIdInput");
  const passwordInput = document.getElementById("passwordInput");
  const passwordConfirmInput = document.getElementById("passwordConfirmInput");
  const agreeInput = document.getElementById("agreeInput");
  const errorEl = document.getElementById("signupError");

  // ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœë¼ë©´ êµ³ì´ íšŒì›ê°€ì… í•„ìš” ì—†ìœ¼ë‹ˆ ë§ˆì´í˜ì´ì§€ë¡œ ë³´ë‚´ë„ ë¨ (ì„ íƒ ì‚¬í•­)
  const token = localStorage.getItem("accessToken");
  if (token) {
    // ì›í•˜ë©´ ì£¼ì„ í•´ì œ
    // window.location.href = "/mypage/";
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorEl.textContent = "";

    const name = nameInput.value.trim();
    const loginId = loginIdInput.value.trim();
    const password = passwordInput.value;
    const passwordConfirm = passwordConfirmInput.value;
    const agreed = agreeInput.checked;

    if (!agreed) {
      errorEl.textContent = "ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì•¼ íšŒì›ê°€ì…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
      return;
    }

    if (password !== passwordConfirm) {
      errorEl.textContent = "ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      return;
    }

    if (!name || !loginId || !password) {
      errorEl.textContent = "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      return;
    }

    const payload = {
      name: name,
      login_id: loginId,
      password: password,
      // role: "COOK",  // ì„œë²„ì—ì„œ ê¸°ë³¸ê°’ì´ ìˆë‹¤ë©´ ìƒëµ ê°€ëŠ¥, í•„ìš”í•˜ë©´ ì£¼ì„ í•´ì œ
    };

    try {
      const res = await fetch("/api/auth/signup/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));
      console.log("signup response:", res.status, data);

      if (!res.ok) {
        // ì„œë²„ì—ì„œ ì˜¨ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ê¸°
        if (data && typeof data === "object") {
          if (data.detail) {
            errorEl.textContent = data.detail;
          } else if (data.login_id) {
            errorEl.textContent = data.login_id[0] || "ì•„ì´ë””ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
          } else {
            errorEl.textContent = "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì…ë ¥ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
          }
        } else {
          errorEl.textContent = "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        }
        return;
      }

      // ì—¬ê¸°ì„œ dataì— access/refresh í† í°ì´ ë”¸ë ¤ì˜¤ë©´ ê³§ë°”ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬ë„ ê°€ëŠ¥í•¨.
      // ì˜ˆ: localStorage.setItem("accessToken", data.access);

      alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
      window.location.href = "/login/";

    } catch (err) {
      console.error(err);
      errorEl.textContent = "ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  });
});
</script>
{% endblock %}
