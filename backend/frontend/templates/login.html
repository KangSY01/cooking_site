{% extends "base.html" %}

{% block title %}ë¡œê·¸ì¸ | ìì·¨ìƒì˜ ì°½ì˜ ìš”ë¦¬{% endblock %}

{% block content %}
<section class="auth-page">
  <div class="auth-card">
    <div class="auth-logo-circle">
      <span class="auth-logo-icon">ğŸ³</span>
    </div>

    <h2 class="auth-title">ë¡œê·¸ì¸</h2>
    <p class="auth-subtitle">
      ìì·¨ìƒì˜ ì°½ì˜ ìš”ë¦¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤
    </p>

    <form id="loginForm" class="auth-form">
      <label class="auth-label">
        ì•„ì´ë””
        <input
          type="text"
          id="usernameInput"
          class="auth-input"
          placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          required
        >
      </label>

      <label class="auth-label">
        ë¹„ë°€ë²ˆí˜¸
        <input
          type="password"
          id="passwordInput"
          class="auth-input"
          placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          required
        >
      </label>

      <label class="auth-remember">
        <input type="checkbox" disabled>
        <span>ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€</span>
      </label>

      <button type="submit" class="btn auth-submit">
        ë¡œê·¸ì¸
      </button>

      <p id="loginError" class="error auth-error"></p>
    </form>

    <p class="auth-footer-text">
      ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
      <a href="#" class="auth-link">íšŒì›ê°€ì…</a>
    </p>
  </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("loginForm");
  const usernameInput = document.getElementById("usernameInput");
  const passwordInput = document.getElementById("passwordInput");
  const errorEl = document.getElementById("loginError");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorEl.textContent = "";

    const loginId = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (!loginId || !password) {
      errorEl.textContent = "ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      return;
    }

    try {
      const res = await fetch("/api/auth/login/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          // ë°±ì—”ë“œ ë¡œê·¸ì¸ APIê°€ ê¸°ëŒ€í•˜ëŠ” í•„ë“œëª…ì— ë§ì¶”ê¸°
          login_id: loginId,
          password: password,
        }),
      });

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨", res.status, data);
        errorEl.textContent = data.detail || "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
        return;
      }

            const data = await res.json();
      console.log("ë¡œê·¸ì¸ ì„±ê³µ ì‘ë‹µ:", data);

      const accessToken = data.access || data.token || data.access_token;
      if (!accessToken) {
        console.error("ì‘ë‹µì— í† í°ì´ ì—†ìŠµë‹ˆë‹¤.", data);
        errorEl.textContent = "ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      // âœ… í† í° ì €ì¥
      localStorage.setItem("accessToken", accessToken);

      // âœ… nextUrl ì´ ìˆìœ¼ë©´ ê±°ê¸°ë¡œ, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ
      const nextUrl = localStorage.getItem("nextUrl") || "/mypage/";
      localStorage.removeItem("nextUrl");

      window.location.href = nextUrl;

    } catch (err) {
      console.error(err);
      errorEl.textContent = "ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  });
});
</script>
{% endblock %}

