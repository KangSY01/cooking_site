{% extends "base.html" %}

{% block title %}새 레시피 등록 | 자취생의 창의 요리{% endblock %}

{% block content %}
<section class="recipe-create-page">

  <a href="/" class="go-back">← 취소</a>
  <h1 class="page-title">새 레시피 등록</h1>

  <form id="recipeCreateForm" class="recipe-form" enctype="multipart/form-data">

    <!-- 제목 -->
    <label class="form-label">레시피 제목</label>
    <input type="text" class="form-input" id="titleInput" placeholder="예: 10분 만에 완성하는 김치볶음밥" required>

<!-- 이미지 업로드 -->
<label class="form-label">레시피 사진</label>
<div class="image-upload-box" id="imageUploadBox">
  <!-- ✅ name="image" 추가 -->
  <input type="file" id="imageInput" name="image" accept="image/*" hidden>
  <div class="upload-area">
    <div class="upload-icon">⬆️</div>
    <p class="upload-text">클릭하여 사진 업로드</p>
    <p class="upload-sub">PNG, JPG (최대 10MB)</p>
  </div>
</div>


    <!-- 설명 -->
    <label class="form-label">레시피 설명</label>
    <textarea class="form-textarea" id="descInput" placeholder="레시피에 대한 간단한 설명을 입력하세요"></textarea>

    <!-- 조리시간/태그 -->
    <div class="row">
      <div class="col">
        <label class="form-label">조리 시간(분)</label>
        <input type="text" class="form-input" id="cookTimeInput" placeholder="예: 15분">
      </div>

      <div class="col">
        <label class="form-label">태그</label>
        <input type="text" class="form-input" id="tagInput" placeholder="예: 한식, 간단, 매운맛 (쉼표로 구분)">
      </div>
    </div>

    <!-- 재료 -->
    <div class="ingredients-section">
      <div class="section-title">
        <span>재료</span>
        <button type="button" class="add-btn" id="addIngredientBtn">+ 재료 추가</button>
      </div>

      <div id="ingredientList" class="dynamic-list">
        <div class="ingredient-row">
          <input class="form-input" placeholder="재료명">
          <input class="form-input small" placeholder="양">
          <button type="button" class="row-remove-btn">✕</button>
        </div>
      </div>
    </div>

    <!-- 조리 과정 -->
    <div class="steps-section">
      <div class="section-title">
        <span>조리 과정</span>
        <button type="button" class="add-btn" id="addStepBtn">+ 단계 추가</button>
      </div>

      <div id="stepList" class="dynamic-list">
        <div class="step-row">
          <span class="step-badge">1</span>
          <input class="form-input" placeholder="조리 단계를 입력하세요">
          <button type="button" class="row-remove-btn">✕</button>
        </div>
      </div>
    </div>

    <!-- 버튼 영역 -->
    <div class="form-buttons">
      <button type="button" class="btn-cancel">취소</button>
      <button type="submit" class="btn-submit">등록하기</button>
    </div>

  </form>

</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // 0) 로그인 여부 확인 (토큰 키 통일)
  const token =
    localStorage.getItem("access") ||
    localStorage.getItem("token");

  if (!token) {
    alert("로그인 후 레시피를 등록할 수 있습니다.");
    window.location.href = "/login/";
    return;
  }

  // 재료 추가 / 삭제
  const addIngredientBtn = document.getElementById("addIngredientBtn");
  const ingredientList = document.getElementById("ingredientList");

  addIngredientBtn.addEventListener("click", () => {
    const row = document.createElement("div");
    row.className = "ingredient-row";
    row.innerHTML = `
      <input class="form-input" placeholder="재료명">
      <input class="form-input small" placeholder="양">
      <button type="button" class="row-remove-btn">✕</button>
    `;
    ingredientList.appendChild(row);
  });

  ingredientList.addEventListener("click", (e) => {
    if (e.target.classList.contains("row-remove-btn")) {
      const row = e.target.closest(".ingredient-row");
      if (row) row.remove();
    }
  });

  // 조리 단계 추가 / 삭제
  const addStepBtn = document.getElementById("addStepBtn");
  const stepList = document.getElementById("stepList");

  addStepBtn.addEventListener("click", () => {
    const stepNum = stepList.children.length + 1;
    const row = document.createElement("div");
    row.className = "step-row";
    row.innerHTML = `
      <span class="step-badge">${stepNum}</span>
      <input class="form-input" placeholder="조리 단계를 입력하세요">
      <button type="button" class="row-remove-btn">✕</button>
    `;
    stepList.appendChild(row);
  });

  stepList.addEventListener("click", (e) => {
    if (e.target.classList.contains("row-remove-btn")) {
      const row = e.target.closest(".step-row");
      if (row) {
        row.remove();
        renumberSteps();
      }
    }
  });

  function renumberSteps() {
    const badges = stepList.querySelectorAll(".step-badge");
    badges.forEach((badge, idx) => {
      badge.textContent = idx + 1;
    });
  }

  // 이미지 업로드 박스 클릭 시 파일 선택
  const imageUploadBox = document.getElementById("imageUploadBox");
  const imageInput = document.getElementById("imageInput");

  imageUploadBox.addEventListener("click", () => {
    imageInput.click();
  });

  // 취소 버튼: 메인으로 이동
  const cancelBtn = document.querySelector(".btn-cancel");
  cancelBtn.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = "/";
  });

  // 폼 제출 → /api/recipes/create/ (FormData + authFetch)
  const form = document.getElementById("recipeCreateForm");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("titleInput").value.trim();
    const description = document.getElementById("descInput").value.trim();
    const cookingTime = document.getElementById("cookTimeInput").value.trim();
    const tagsRaw = document.getElementById("tagInput").value.trim();

    if (!title) {
      alert("레시피 제목을 입력해주세요.");
      return;
    }

    // 재료 배열
    const ingredientRows = document.querySelectorAll("#ingredientList .ingredient-row");
    const ingredients = [];
    ingredientRows.forEach((row) => {
      const [nameInput, amountInput] = row.querySelectorAll("input");
      const name = nameInput.value.trim();
      const amount = amountInput.value.trim();
      if (name) {
        ingredients.push({ name, amount });
      }
    });

    // 단계 배열
    const stepRows = document.querySelectorAll("#stepList .step-row");
    const steps = [];
    stepRows.forEach((row, idx) => {
      const input = row.querySelector("input");
      const content = input.value.trim();
      if (content) {
        steps.push({ content, step_order: idx + 1 });
      }
    });

    const fd = new FormData();
    fd.append("title", title);
    fd.append("description", description);
    fd.append("cooking_time", cookingTime);
    fd.append("tags", tagsRaw);

    ingredients.forEach((ing, idx) => {
      fd.append(`ingredients[${idx}][name]`, ing.name);
      fd.append(`ingredients[${idx}][amount]`, ing.amount);
    });

    steps.forEach((step, idx) => {
      fd.append(`steps[${idx}][content]`, step.content);
      fd.append(`steps[${idx}][step_order]`, step.step_order);
    });

    if (imageInput.files && imageInput.files[0]) {
      fd.append("image", imageInput.files[0]); // 백엔드에서 request.FILES["image"]
    }

    // 디버깅하고 싶으면 이거 잠깐 켜보면 됨
    // console.log([...fd.entries()]);

    try {
      const res = await authFetch("/api/recipes/create/", {
        method: "POST",
        body: fd,
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        console.error("레시피 등록 실패", errData);
        alert("레시피 등록에 실패했습니다.");
        return;
      }

      const data = await res.json().catch(() => ({}));
      alert("레시피가 등록되었습니다!");

      if (data.recipe_id) {
        window.location.href = `/recipes/${data.recipe_id}/`;
      } else {
        window.location.href = "/";
      }
    } catch (err) {
      console.error(err);
      alert("서버와 통신 중 오류가 발생했습니다.");
    }
  });
});
</script>


{% endblock %}
