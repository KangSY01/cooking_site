{% extends "base.html" %}
{% load static %}
{% block title %}ë ˆì‹œí”¼ ìƒì„¸ | ìì·¨ìƒì˜ ì°½ì˜ ìš”ë¦¬{% endblock %}

{% block content %}
<script src="{% static 'js/recipe_detail.js' %}"></script>

<section id="recipeDetailPage" class="recipe-detail-page" data-recipe-id="{{ recipe_id }}">

  <!-- ìƒë‹¨ ì˜ì—­: ì œëª© + ë©”íƒ€ -->
  <header class="recipe-detail-header">
    <div class="breadcrumb">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</div>

    <div class="recipe-detail-top">
      <div>
        <h1 id="recipeTitle" class="recipe-detail-title">ë ˆì‹œí”¼ ì œëª©</h1>
        <p id="recipeSubtitle" class="recipe-detail-sub">
          ê°„ë‹¨í•œ ì„¤ëª… í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.
        </p>
        <div class="recipe-detail-meta">
          <span id="recipeAuthor">ì‘ì„±ì: -</span>
          <span id="recipeTime">â± -ë¶„</span>
        </div>
        <div id="recipeTags" class="recipe-tags">
          <!-- íƒœê·¸ ë²„íŠ¼ë“¤ -->
        </div>
      </div>

      <div id="recipeActions" style="display:none;">
  <button type="button" id="deleteRecipeBtn">ì‚­ì œí•˜ê¸°</button>
</div>


    </div>

    <div class="recipe-detail-stats">
      <button id="subscribeBtn" class="btn primary small">êµ¬ë…í•˜ê¸°</button>

      <div class="recipe-detail-rating">
        <span>í‰ì :</span>
        <span id="recipeStars">â­â­â­â­â­</span>
        <span id="recipeAvgScore" class="rating-score">0.0</span>
        <span id="recipeRatingCount" class="rating-count">0ëª… í‰ê°€</span>
      </div>

      <div class="recipe-detail-likes">
        <button id="likeToggleBtn" class="btn-outline small">â¤ ì¢‹ì•„ìš”</button>
        <span id="recipeLikeCount">0</span>
      </div>
    </div>
  </header>

  <!-- ëŒ€í‘œ ì´ë¯¸ì§€ -->
  <section class="recipe-detail-image-section">
    <img id="recipeImage" src="" alt="ë ˆì‹œí”¼ ì´ë¯¸ì§€" class="recipe-detail-image">
  </section>

  <!-- ì¬ë£Œ / ì¡°ë¦¬ ê³¼ì • 2ì»¬ëŸ¼ -->
  <section class="recipe-detail-main">
    <div class="recipe-detail-column">
      <h2 class="column-title">ì¬ë£Œ</h2>
      <ul id="ingredientList" class="ingredient-list">
        <!-- JSë¡œ ì±„ì›€ -->
      </ul>
    </div>

    <div class="recipe-detail-column">
      <h2 class="column-title">ì¡°ë¦¬ ê³¼ì •</h2>
      <ol id="stepList" class="step-list">
        <!-- JSë¡œ ì±„ì›€ -->
      </ol>
    </div>
  </section>

  <!-- ëŒ“ê¸€ ì˜ì—­ -->
  <section class="recipe-detail-comments">
    <h2 class="column-title">
      ëŒ“ê¸€ <span id="commentCount">(0)</span>
    </h2>

    <!-- ëŒ“ê¸€ ì…ë ¥ ë°•ìŠ¤ -->
    <div class="comment-input-box">
      <textarea
        id="commentInput"
        class="comment-textarea"
        placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
        rows="3"
      ></textarea>
      <button id="commentSubmitBtn" class="btn primary small">ëŒ“ê¸€ ì‘ì„±</button>
    </div>

    <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
    <div id="commentList" class="comment-list">
      <!-- JSë¡œ ëŒ“ê¸€ ì¹´ë“œë“¤ ë Œë”ë§ -->
    </div>
  </section>

</section>

<style>
  .recipe-detail-page {
    max-width: 960px;
    margin: 32px auto 60px;
  }
  .recipe-detail-header {
    margin-bottom: 24px;
  }
  .breadcrumb {
    font-size: 13px;
    color: #888;
    margin-bottom: 8px;
    cursor: pointer;
  }
  .recipe-detail-top {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    align-items: flex-start;
  }
  .recipe-detail-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .recipe-detail-sub {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
  }
  .recipe-detail-meta span {
    font-size: 13px;
    color: #888;
    margin-right: 10px;
  }
  .recipe-tags {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .recipe-tag-pill {
    padding: 3px 8px;
    border-radius: 999px;
    background: #fff4e3;
    font-size: 12px;
    color: #c85a00;
  }
  .recipe-detail-actions {
    display: flex;
    gap: 8px;
  }
  .btn-outline.small {
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fff;
    cursor: pointer;
  }
  .btn.primary.small {
    font-size: 13px;
    padding: 8px 16px;
    border-radius: 999px;
    border: none;
    background: #e56600;
    color: #fff;
    cursor: pointer;
  }
  .recipe-detail-stats {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 16px;
    font-size: 13px;
  }
  .recipe-detail-rating span {
    margin-right: 4px;
  }
  .rating-score {
    font-weight: 600;
  }
  .recipe-detail-image-section {
    margin: 24px 0;
  }
  .recipe-detail-image {
    width: 100%;
    border-radius: 18px;
    object-fit: cover;
    max-height: 420px;
  }
  .recipe-detail-main {
    display: grid;
    grid-template-columns: 1.1fr 1.3fr;
    gap: 24px;
    margin-bottom: 32px;
  }
  .column-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 12px;
  }
  .ingredient-list,
  .step-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .ingredient-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 10px;
    border-radius: 10px;
    background: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    font-size: 13px;
    margin-bottom: 6px;
  }
  .step-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 10px;
    background: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    font-size: 13px;
    margin-bottom: 8px;
  }
  .step-badge {
    width: 20px;
    height: 20px;
    border-radius: 999px;
    background: #ffb380;
    color: #fff;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* ëŒ“ê¸€ ì˜ì—­ */
  .recipe-detail-comments {
    margin-top: 12px;
  }
  .comment-input-box {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
  }
  .comment-textarea {
    flex: 1;
    resize: none;
    border-radius: 12px;
    border: 1px solid #ddd;
    padding: 8px 10px;
    font-size: 13px;
  }
  .comment-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .comment-item {
    display: flex;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    font-size: 13px;
  }
  .comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #ffe1c5;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .comment-body {
    flex: 1;
  }
  .comment-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .comment-author {
    font-weight: 600;
  }
  .comment-date {
    font-size: 11px;
    color: #888;
  }
  .comment-content {
    font-size: 13px;
    white-space: pre-wrap;
  }
  .comment-delete {
    font-size: 11px;
    color: #c44;
    cursor: pointer;
    margin-left: 8px;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const pageEl = document.getElementById("recipeDetailPage");
  const recipeId = pageEl.dataset.recipeId;

  const token = localStorage.getItem("accessToken");
  let currentMemberId = null;  // ë‚´ ëŒ“ê¸€ ì‚­ì œ ì—¬ë¶€ íŒë‹¨ìš©

  // ====== ê³µí†µ DOM ======
  const titleEl = document.getElementById("recipeTitle");
  const subEl = document.getElementById("recipeSubtitle");
  const authorEl = document.getElementById("recipeAuthor");
  const timeEl = document.getElementById("recipeTime");
  const tagsEl = document.getElementById("recipeTags");
  const imageEl = document.getElementById("recipeImage");
  const avgScoreEl = document.getElementById("recipeAvgScore");
  const ratingCountEl = document.getElementById("recipeRatingCount");
  const likeCountEl = document.getElementById("recipeLikeCount");
  const ingredientListEl = document.getElementById("ingredientList");
  const stepListEl = document.getElementById("stepList");
  const commentListEl = document.getElementById("commentList");
  const commentCountEl = document.getElementById("commentCount");
  const commentInput = document.getElementById("commentInput");
  const commentSubmitBtn = document.getElementById("commentSubmitBtn");

  // ====== 1) ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (ëŒ“ê¸€ ì‚­ì œ/í‘œì‹œìš©) ======
  if (token) {
    fetch("/api/auth/me/", {
      headers: { Authorization: `Bearer ${token}` },
    })
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data && data.member_id) {
          currentMemberId = data.member_id;
        }
      })
      .catch(() => {});
  }

  // ====== 2) ë ˆì‹œí”¼ ìƒì„¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ======
  async function loadRecipeDetail() {
    try {
      const res = await fetch(`/api/recipes/${recipeId}/`);
      const data = await res.json();
      if (!res.ok) {
        console.error("ë ˆì‹œí”¼ ìƒì„¸ ì‹¤íŒ¨", data);
        return;
      }

      // ì—¬ê¸°ì„œ data êµ¬ì¡°ëŠ” ë„ˆì˜ RecipeDetailSerializerì— ë§ê²Œ ì•½ê°„ ìˆ˜ì •í•  ìˆ˜ ìˆìŒ
      titleEl.textContent = data.title || "";
      subEl.textContent = data.description || "";
      authorEl.textContent = data.author_name ? `ì‘ì„±ì: ${data.author_name}` : "";
      if (data.cooking_time) {
        timeEl.textContent = `â± ${data.cooking_time}ë¶„`;
      }

      // ëŒ€í‘œ ì´ë¯¸ì§€
      if (data.image_path) {
        imageEl.src = data.image_path;
      } else {
        imageEl.src = "https://via.placeholder.com/960x400?text=No+Image";
      }

      // íƒœê·¸
      tagsEl.innerHTML = "";
      const tags = data.tags || [];  // ["í•œì‹","ê°„ë‹¨","ë§¤ìš´ë§›"] ê°™ì€ í˜•íƒœë¼ê³  ê°€ì •
      tags.forEach(tag => {
        const pill = document.createElement("span");
        pill.className = "recipe-tag-pill";
        pill.textContent = `#${tag}`;
        tagsEl.appendChild(pill);
      });

      // í‰ì  / ì¢‹ì•„ìš”
      if (typeof data.avg_score !== "undefined" && data.avg_score !== null) {
        avgScoreEl.textContent = data.avg_score.toFixed
          ? data.avg_score.toFixed(1)
          : data.avg_score;
      }
      ratingCountEl.textContent = data.rating_count
        ? `${data.rating_count}ëª… í‰ê°€`
        : "0ëª… í‰ê°€";
      likeCountEl.textContent = data.like_count ?? 0;

      // ì¬ë£Œ
      ingredientListEl.innerHTML = "";
      const ingredients = data.ingredients || []; // [{name, amount}, ...]
      ingredients.forEach(ing => {
        const li = document.createElement("li");
        li.className = "ingredient-item";
        li.innerHTML = `
          <span>${ing.name}</span>
          <span>${ing.amount || ""}</span>
        `;
        ingredientListEl.appendChild(li);
      });

      // ë‹¨ê³„
      stepListEl.innerHTML = "";
      const steps = data.steps || []; // [{step_order, content}, ...]
      steps
        .sort((a, b) => (a.step_order || 0) - (b.step_order || 0))
        .forEach(step => {
          const li = document.createElement("li");
          li.className = "step-item";
          li.innerHTML = `
            <div class="step-badge">${step.step_order}</div>
            <div>${step.content}</div>
          `;
          stepListEl.appendChild(li);
        });

    } catch (err) {
      console.error(err);
    }
  }

  // ====== 3) ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ======
  async function loadComments() {
    try {
      const res = await fetch(`/api/recipes/${recipeId}/comments/`);
      const data = await res.json();
      if (!res.ok) {
        console.error("ëŒ“ê¸€ ëª©ë¡ ì‹¤íŒ¨", data);
        return;
      }

      const comments = Array.isArray(data) ? data : data.results || [];
      commentCountEl.textContent = `(${comments.length})`;
      commentListEl.innerHTML = "";

      comments.forEach(comment => {
        const item = document.createElement("div");
        item.className = "comment-item";

        const canDelete =
          currentMemberId && comment.author_id === currentMemberId;

        item.innerHTML = `
          <div class="comment-avatar">ğŸ‘¤</div>
          <div class="comment-body">
            <div class="comment-meta">
              <div>
                <span class="comment-author">${comment.author_name || "ìµëª…"}</span>
                <span class="comment-date">${formatDate(comment.created_at)}</span>
              </div>
              ${
                canDelete
                  ? `<span class="comment-delete" data-comment-id="${comment.comment_id}">ì‚­ì œ</span>`
                  : ""
              }
            </div>
            <div class="comment-content">${escapeHtml(comment.content || "")}</div>
          </div>
        `;
        commentListEl.appendChild(item);
      });
    } catch (err) {
      console.error(err);
    }
  }

  function formatDate(isoString) {
    if (!isoString) return "";
    const d = new Date(isoString);
    return `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}`;
  }

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.innerText = text;
    return div.innerHTML;
  }

  // ====== 4) ëŒ“ê¸€ ì‘ì„± (ë¡œê·¸ì¸ í•„ìš”) ======
  function ensureLoginOrRedirect() {
    const token = localStorage.getItem("accessToken");
    if (!token) {
      alert("ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      localStorage.setItem("nextUrl", window.location.pathname);
      window.location.href = "/login/";
      return false;
    }
    return true;
  }

  // í¬ì»¤ìŠ¤ë§Œ í•´ë„ ë¡œê·¸ì¸ ì²´í¬ (ìš”êµ¬ì‚¬í•­)
  commentInput.addEventListener("focus", () => {
    ensureLoginOrRedirect();
  });

  // ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ“ê¸€ ì‘ì„±
  commentSubmitBtn.addEventListener("click", async () => {
    if (!ensureLoginOrRedirect()) return;

    const token = localStorage.getItem("accessToken");
    const content = commentInput.value.trim();
    if (!content) {
      alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const res = await fetch(`/api/recipes/${recipeId}/comments/create/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ content }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        console.error("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨", data);
        alert("ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      commentInput.value = "";
      await loadComments();
    } catch (err) {
      console.error(err);
      alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });

  // ====== 5) ëŒ“ê¸€ ì‚­ì œ (ë‚´ ëŒ“ê¸€ë§Œ) ======
  commentListEl.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("comment-delete")) return;
    if (!ensureLoginOrRedirect()) return;

    const commentId = e.target.dataset.commentId;
    if (!commentId) return;

    if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const token = localStorage.getItem("accessToken");

    try {
      const res = await fetch(`/api/comments/${commentId}/`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      if (!res.ok && res.status !== 204) {
        console.error("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨", res.status);
        alert("ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      await loadComments();
    } catch (err) {
      console.error(err);
      alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });

  // ========= ì´ˆê¸° ë¡œë“œ =========
  loadRecipeDetail();
  loadComments();

  // ë¸Œë ˆë“œí¬ëŸ¼ í´ë¦­ ì‹œ ë©”ì¸ìœ¼ë¡œ
  document.querySelector(".breadcrumb").addEventListener("click", () => {
    window.location.href = "/";
  });
});
</script>
{% endblock %}
